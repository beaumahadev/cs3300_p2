<html>
<head>
<title>INFO 3300 - Project 2</title>
<link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<style>
body { font-family: 'Merriweather', Calibri, sans-serif; }
svg { border: solid #ccc 1px; }
div.tooltip { 
    position: absolute;     
    text-align: center;     
    width: 60px;          
    height: 28px;         
    padding: 2px;       
    font: 12px sans-serif;    
    background: #626D71; 
    color: white;
    border: 0px;    
    border-radius: 8px;     
    pointer-events: none;     
}
</style>
</head>
<body>

<div id="plot"></div>

<script>

var widthScatter=200;
var heightScatter=200;
var minProfit=1000;
var maxProfit=1000000;


var testData=[];
var size=Math.random() * (10 - 3) + 3;
for(var i=0;i<size;i++){
  testData.push({name: "Company"+i, profit: Math.random() * (maxProfit - minProfit) + minProfit, companytype: Math.random() * (3)});
}

//Creates a scatterplot within a circle. Takes as input an array of objects containing company name and the profit.  
function scatterplot(data){

  var scatterSVG = d3.select("#plot").append("svg")
. attr("height", widthScatter).attr("width", heightScatter);
  
  var tooldiv = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);




  var averageProfit= (minProfit+maxProfit)/2;
  var totalProfit=0;

  for(d in data){
    totalProfit+=data[d].profit;
  }



  scatterSVG.selectAll("circle").remove();


  var rScale = d3.scaleLinear().domain([minProfit, maxProfit]).range([3, widthScatter/(2*Math.sqrt(totalProfit/averageProfit))]);
  var colorScale = d3.scaleOrdinal().domain([0,1,2]).range(["#4286f4","#23d15a","#8e49a3"]);
  console.log(totalProfit/averageProfit);



  var numNodes = data.length;
  var nodes = d3.range(numNodes).map(function(d) {
    return {radius: rScale(data[d].profit), color: colorScale(data[d].companytype), name: data[d].name, profit: data[d].profit}
  })

  console.log(nodes);

  var boxForce = boundedBox()
    .bounds([[0, 0], [widthScatter, heightScatter]])
    .size(function (d) { return [d.size, d.size] })

  var simulation = d3.forceSimulation(nodes)
    .force('charge', d3.forceManyBody().strength(5))
    .force('center', d3.forceCenter(widthScatter / 2, heightScatter / 2))
    .force('collision', d3.forceCollide().radius(function(d) {
      return d.radius
    }))
    .force('box', boxForce)
    .on('tick', ticked);

  function ticked() {
    var u = d3.select('svg')
      .selectAll('circle')
      .data(nodes)

    u.enter()
      .append('circle')
      .attr('r', function(d) {
        return d.radius;
      })
      .style("fill", function (d) {
        return d.color;
            })
      .merge(u)
      .attr('cx', function(d) {
        return d.x
      })
      .attr('cy', function(d) {
        return d.y
      })
      .on("mouseover", function(d) {    
        tooldiv.transition()    
           .duration(200)    
           .style("opacity", .9);    
        tooldiv .html(d.name + "<br/>"  + d.profit.toFixed(2))  
            .style("left", (d3.event.pageX) + "px")   
            .style("top", (d3.event.pageY - 28) + "px");  
      })          
      .on("mouseout", function(d) {   
        tooldiv.transition()    
           .duration(500)    
           .style("opacity", 0); 
      });

    u.exit().remove()
  }
}
  //Code for bounding box taken from https://bl.ocks.org/cmgiven/547658968d365bcc324f3e62e175709b
  function boundedBox() {
    var nodes, sizes
    var bounds
    var size = [0, 0]

    function force() {
        var node, size
        var xi, x0, x1, yi, y0, y1
        var i = -1
        while (++i < nodes.length) {
            node = nodes[i]
            size = sizes[i]
            xi = node.x + node.vx
            x0 = bounds[0][0] - xi
            x1 = bounds[1][0] - (xi + size[0])
            yi = node.y + node.vy
            y0 = bounds[0][1] - yi
            y1 = bounds[1][1] - (yi + size[1])
            if (x0 > 0 || x1 < 0) {
                node.x += node.vx
                node.vx = -node.vx
                if (node.vx < x0) { node.x += x0 - node.vx }
                if (node.vx > x1) { node.x += x1 - node.vx }
            }
            if (y0 > 0 || y1 < 0) {
                node.y += node.vy
                node.vy = -node.vy
                if (node.vy < y0) { node.vy += y0 - node.vy }
                if (node.vy > y1) { node.vy += y1 - node.vy }
            }
        }
    }

    force.initialize = function (_) {
        sizes = (nodes = _).map(size)
    }

    force.bounds = function (_) {
        return (arguments.length ? (bounds = _, force) : bounds)
    }

    force.size = function (_) {
        return (arguments.length
             ? (size = typeof _ === 'function' ? _ : constant(_), force)
             : size)
    }

    return force
}
scatterplot(testData);


</script>


</body>
</html>
