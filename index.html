<html>
<head>
<title>INFO 3300 - Project 2</title>
<link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<style>
body { font-family: 'Merriweather', Calibri, sans-serif; }
div.donut{ 
  display: flex;
  justify-content: left;
 }
div.infobox{
  top: 20;
  right: 20;
  width: 300px;
  height: 300px;
  background: red;
}
div.tooltip { 
    position: absolute;     
    text-align: center;     
    width: 60px;          
    height: 28px;         
    padding: 10px;       
    font: 12px sans-serif;    
    background: #626D71; 
    color: white;
    border: 0px;    
    border-radius: 8px;     
    pointer-events: none;     
}
body{
  background-color:#25183a;
}
</style>
</head>
<body>

<div id="plot">
  <div id="donut"></div>
  <div id="infobox"></div>
</div>

<script>

var widthScatter=250;
var heightScatter=250;
var minProfit=1000;
var maxProfit=1000000;
var height = 1100;
var width = 1100;

var warDataReal = [];
var counter = -1;

var innerColorScale = d3.scaleOrdinal()
    .range(["#468B81","#B9D46E","#E3CE6B","#DE6D51","#C5424E","#B9D46E","#E3CE6B","#DE6D51"])
    .domain([0, companySize]);

d3.queue()
        .defer(d3.csv, "data/wars.csv")
        .await(callback)
        function callback (error, data) {
          data.forEach(function(d) {
            d.name = d["Name of Conflict"];
            if (d.Finish === "Ongoing") {
              d.Finish = 2018;
            }
            d.duration = d.Finish - d.Start + 1;
            d.companies = getCompanies(companySize);
            d.id = counter;
            d.desc = d["Description"];
            counter++;
            warDataReal.push(d);
          });
          warDataReal.shift();
          console.log(warDataReal);
          donutchartinner(companyData);
          donutchartouter(warDataReal);
          //donutchartouter(warData);

        }

d3.csv("data/wars.csv", function(data) {
  
});


var companySize=Math.random() * (50 - 30) + 30;
//var warSize= warDataReal.length;
var warSize = Math.random() * (50 - 30) + 30;
var companyData=[];
var warData=[];

for(var i=0;i<companySize;i++){
  companyData.push({name: "Company"+ i, id: i, profit: Math.random() * (maxProfit - minProfit) + minProfit});
}

function getCompanies(int){
  var num=Math.random() * (10 - 3) + 3;
  var companies = []
  for(var i=0;i<num;i++){
    companies.push("Company"+Math.floor(Math.random() * (int)));

  }
  return companies;
}

//for testing purposes
for(var i=0;i<warSize;i++){
  warData.push({name: "War"+i, id: i, duration: Math.random() * (100 - 10) + 10, companies: getCompanies(companySize)});
}

var mainSVG = d3.select("#donut").append('svg')
.attr("height", height).attr("width", width);

//Creates a scatterplot within a circle. Takes as input an array of objects containing company name and the profit.  
function scatterplot(rawdata, colors){

  var data=[]
  for(var d in rawdata){
    for(var c in companyData){
      if(rawdata[d] == companyData[c].name){
        data.push(companyData[c]);
      }
    }
  }

  var padding=20;
  var scatterSVG = mainSVG.append("g")

    .attr("id", function(d) { return "scatterSVG"})
    .attr("height", widthScatter+padding).attr("width", heightScatter+padding)
    .attr("transform", "translate(" + (width/2 - widthScatter/2) + "," + (height/2 - heightScatter/2) + ")" );
  
  var tooldiv = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);


  var averageProfit= (minProfit+maxProfit)/2;
  var totalProfit=0;

  for(d in data){
    totalProfit+=data[d].profit;
  }

  var rScale = d3.scaleLinear().domain([minProfit, maxProfit]).range([8, widthScatter/(2*Math.sqrt(totalProfit/averageProfit))]);


  var numNodes = data.length;
  var nodes = d3.range(numNodes).map(function(d) {
    return {radius: rScale(data[d].profit), color: data[d].color, name: data[d].name, profit: data[d].profit}
  })

  var boxForce = boundedBox()
    .bounds([[0, 0], [widthScatter, heightScatter]])
    .size(function (d) { return [d.size, d.size] })

  var boxForce2 = boundedBox()
    .bounds([[0, 0], [widthScatter*1.5, heightScatter*1.5]])
    .size(function (d) { return [d.size, d.size] })

  var simulation = d3.forceSimulation(nodes)
    .force('charge', d3.forceManyBody().strength(3))
    .force('center', d3.forceCenter(widthScatter / 2, heightScatter / 2))
    .force('collision', d3.forceCollide().radius(function(d) {
      return d.radius
    }))
    .force('box', boxForce)
    .force('box', boxForce2)
    .on('tick', ticked);

  function ticked() {
    var u = scatterSVG
      .selectAll('circle')
      .data(nodes)

    u.enter()
      .append('circle')
      .attr('r', function(d) {
        return d.radius;
      })
      .style("fill", function (d) {
        return d.color;
            })
      .merge(u)
      .attr('cx', function(d) {
        return d.x;
      })
      .attr('cy', function(d) {
        return d.y;
      })
      .on("mouseover", function(d) {    
        tooldiv.transition()    
           .duration(200)    
           .style("opacity", .9);    
        tooldiv .html(d.name + "<br/>"  + d.profit.toFixed(2))  
            .style("left", (d3.event.pageX) + "px")   
            .style("top", (d3.event.pageY - 28) + "px");  
      })          
      .on("mouseout", function(d) {   
        tooldiv.transition()    
           .duration(500)    
           .style("opacity", 0); 
      });

    u.exit().remove()

    //.attr("transform", "translate(" + width/2 + "," + height/2 + ")" )
  }
}
  //Code for bounding box taken from https://bl.ocks.org/cmgiven/547658968d365bcc324f3e62e175709b
  function boundedBox() {
    var nodes, sizes
    var bounds
    var size = [0, 0]

    function force() {
        var node, size
        var xi, x0, x1, yi, y0, y1
        var i = -1
        while (++i < nodes.length) {
            node = nodes[i]
            size = sizes[i]
            xi = node.x + node.vx
            x0 = bounds[0][0] - xi
            x1 = bounds[1][0] - (xi + size[0])
            yi = node.y + node.vy
            y0 = bounds[0][1] - yi
            y1 = bounds[1][1] - (yi + size[1])
            if (x0 > 0 || x1 < 0) {
                node.x += node.vx
                node.vx = -node.vx
                if (node.vx < x0) { node.x += x0 - node.vx }
                if (node.vx > x1) { node.x += x1 - node.vx }
            }
            if (y0 > 0 || y1 < 0) {
                node.y += node.vy
                node.vy = -node.vy
                if (node.vy < y0) { node.vy += y0 - node.vy }
                if (node.vy > y1) { node.vy += y1 - node.vy }
            }
        }
    }
    force.initialize = function (_) {
        sizes = (nodes = _).map(size)
    }

    force.bounds = function (_) {
        return (arguments.length ? (bounds = _, force) : bounds)
    }

    force.size = function (_) {
        return (arguments.length
             ? (size = typeof _ === 'function' ? _ : constant(_), force)
             : size)
    }

    return force
}

//pie construction from https://bl.ocks.org/mbostock/3887193
function donutchartouter(data) {

var outerWidth = 400;
var outerHeight = 400;
var outerRadius = Math.min(outerWidth, outerHeight) / 2;

var arc = d3.arc()
.outerRadius(outerRadius - 20)
.innerRadius(outerRadius - 35)
.cornerRadius(2);

var pie = d3.pie()
.sort(null)
.value(function (d) {return d.duration})
.padAngle(.02);

var donutSVG = mainSVG.append('g')
.attr('height', height).attr('width', width);

var infodiv;

var g = donutSVG.selectAll('.arc')
.data(pie(data))
.enter().append('g')
.attr('class', 'arc')
.attr("id", function(d) {return d.data.name })
.attr("transform", "translate(" + width/2 + "," + height/2 + ")" )
.on("mouseover", function(d) {
  console.log(d.data.name);
  console.log(g.select);
 // console.log(g.select('#'+d.data.name).selectAll("path").style("fill"));
  //g.selectAll("path").style("fill", function(d){d3.rgb(d3.select('#'+d.data.name).selectAll("path").style("fill")).darker(1)});
  
  //infodiv = displayInfoBox(d.data.name, d.data.desc);
  /*infodiv.transition()    
           .duration(200)    
           .style("visibility", "visible"); */

  d3.select(this).style("fill", d3.select(this).attr('stroke')).attr('opacity', .3);


  var colors = [];
  for(var i in d.data.companies){
    var arc = d3.select('g#' + d.data.companies[i]);
    var currentcolor=arc.selectAll("path").style("fill");
    colors.push({name: d.data.companies[i], color: currentcolor});
    arc
      .style("fill", d3.select(this).attr('stroke')).attr('opacity', 0.3);
   
  }
  scatterplot(d.data.companies, colors);
})
.on("mouseout", function(d) {
  d3.select(this).style("fill", d3.select(this).attr('stroke')).attr('opacity', 1);
  var scatter= d3.select('#scatterSVG').remove();
  for(var i in d.data.companies){
    var arc = d3.select('g#' + d.data.companies[i]);
    var currentcolor=arc.selectAll("path").style("fill");
    arc
      .style("fill", d3.select(this).attr('stroke')).attr('opacity', 1);
  }
});

g.append('path')
.attr('d', arc)
.style('fill', '#cdcdcd');

var textArc = d3.arc()
.outerRadius(outerRadius + 5)
.innerRadius(outerRadius);

//rotated text from http://bl.ocks.org/vigorousnorth/7331bb51d4f0c2ae0314
g.append('text')
.text(function(d) {return d.data.name;})
.attr('dy', '0.25em')
.style("font-size", "10px")
.attr("text-anchor", function(d) {
  var midAngle = d.endAngle < Math.PI ? d.startAngle/2 + d.endAngle/2 : d.startAngle/2  + d.endAngle/2;
  console.log(midAngle);

  if (midAngle > Math.PI) return "end";
  else return "start";})
.attr("transform", function(d) { 
      var midAngle = d.endAngle < Math.PI ? d.startAngle/2 + d.endAngle/2 : d.startAngle/2  + d.endAngle/2 + Math.PI ;
      return "translate(" + textArc.centroid(d)[0] + "," + textArc.centroid(d)[1] + ") rotate(-90) rotate(" + (midAngle * 180/Math.PI) + ")"; })
.style("fill", "#cdcdcd");

var circleArc = d3.arc()
.outerRadius(outerRadius - 50)
.innerRadius(outerRadius - 60);

g.append('circle')
.attr("cx", function(d) {return circleArc.centroid(d)[0];})
.attr("cy", function(d) {return circleArc.centroid(d)[1];})
.attr("r", 2)
.style("fill", "#cdcdcd");

}

function donutchartinner(data) {
var innerWidth = 350;
var innerHeight = 350;
var innerRadius = Math.min(innerWidth, innerHeight) / 2;

var arc = d3.arc()
.outerRadius(innerRadius - 20)
.innerRadius(innerRadius - 35)
.cornerRadius(2);

var pie = d3.pie()
.sort(null)
.value(10)
.padAngle(.02);

var innerSVG = mainSVG.append('g')
.attr('height', innerHeight).attr('width', innerWidth)
.attr("transform", "translate(" + (width/2 - innerWidth/2) + "," + (height/2 - innerHeight/2) + ")" );

var g  = innerSVG.selectAll('.arc')
.data(pie(data))
.enter().append('g')
.attr('class', 'arc')
.attr("transform", "translate(" + innerWidth/2 + "," + innerHeight/2 + ")" )
.attr("id", function(d) { return d.data.name })
.on("mouseover", function(d) {
  console.log(d.data.name);
  console.log( this.getBoundingClientRect());
}) ;

g.append('path')
.attr('d', arc)
.style('fill', function(d){
  d.data.color = innerColorScale(d.data.id);
  return d.data.color;
  });

var circleArc = d3.arc()
.outerRadius(innerRadius + 5)
.innerRadius(innerRadius);

g.append('circle')
.attr("cx", function(d) {return circleArc.centroid(d)[0];})
.attr("cy", function(d) {return circleArc.centroid(d)[1];})
.attr("r", 2)
.style("fill", "#cdcdcd");

}

function displayInfoBox(name, desc) {
  var infodiv = d3.select("#infobox").append('svg')
    .attr("height", 300).attr("width", 300);

  infodiv.append('text')
  .text(name + "\n" + desc)
  .style("fill", "#cdcdcd") 
  .style("font-size", "10px");

  return infodiv;
}



</script>
</body>
</html>
